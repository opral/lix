#!/usr/bin/env node
import { promises as fs } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";
import { createRequire } from "node:module";

const require = createRequire(import.meta.url);
const __dirname = dirname(fileURLToPath(import.meta.url));

const wasmRelativePath = "sqlite-wasm/jswasm/sqlite3.wasm";
const targetFile = join(__dirname, "..", "src", "backend", "wasm-sqlite.wasm.ts");
const bytesPerLine = 20;

function chunk(values, size) {
  const result = [];
  for (let i = 0; i < values.length; i += size) {
    result.push(values.slice(i, i + size));
  }
  return result;
}

async function main() {
  const pkgPath = require.resolve("@sqlite.org/sqlite-wasm/package.json");
  const packageDir = dirname(pkgPath);
  const wasmPath = join(packageDir, wasmRelativePath);
  const wasmBytes = await fs.readFile(wasmPath);
  const numbers = Array.from(wasmBytes);

  const chunks = chunk(numbers, bytesPerLine);
  const literal = chunks
    .map((group, index) => {
      const suffix = index === chunks.length - 1 ? "" : ",";
      return `\t${group.map((value) => value.toString()).join(", ")}${suffix}`;
    })
    .join("\n");

  const header = `/**\n * @file Auto-generated WebAssembly payload for SQLite.\n *\n * Generated by scripts/embed-sqlite-wasm.js â€” do not edit manually.\n */\n\n`;

  const body = `${header}export const wasmBinary = new Uint8Array([\n${literal}\n]).buffer;\n\nexport default wasmBinary;\n`;

  await fs.mkdir(dirname(targetFile), { recursive: true });
  await fs.writeFile(targetFile, body);
}

main().catch((error) => {
  console.error("[embed-sqlite-wasm] Failed to generate payload:\n", error);
  process.exit(1);
});
