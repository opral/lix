#!/usr/bin/env node
import { readdir, readFile, writeFile, mkdir } from "node:fs/promises";
import { dirname, join, extname, basename } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const repoRoot = join(__dirname, "..", "..", "..");
const engineBuiltinDir = join(repoRoot, "packages", "engine", "src", "builtin_schema");
const outDir = join(repoRoot, "packages", "js-sdk", "src", "generated");
const outFile = join(outDir, "builtin-schemas.ts");

const toPascal = (value) =>
  value
    .split("_")
    .filter(Boolean)
    .map((part) => part[0].toUpperCase() + part.slice(1))
    .join("");

async function main() {
  const entries = await readdir(engineBuiltinDir, { withFileTypes: true });
  const jsonFiles = entries
    .filter((entry) => entry.isFile() && extname(entry.name) === ".json")
    .map((entry) => entry.name)
    .sort();

  const exportBlocks = [];
  for (const file of jsonFiles) {
    const schemaBase = basename(file, ".json");
    const exportName = `${toPascal(schemaBase)}Schema`;
    const raw = await readFile(join(engineBuiltinDir, file), "utf8");
    const parsed = JSON.parse(raw);
    exportBlocks.push(
      `export const ${exportName} = ${JSON.stringify(parsed, null, 2)} as const;`
    );
  }

  const content = `// AUTO-GENERATED by scripts/sync-builtin-schemas.js\n// Source of truth: packages/engine/src/builtin_schema/*.json\n\n${exportBlocks.join("\n\n")}\n`;

  await mkdir(outDir, { recursive: true });
  await writeFile(outFile, content);
}

main().catch((error) => {
  console.error("[sync-builtin-schemas] failed", error);
  process.exit(1);
});
