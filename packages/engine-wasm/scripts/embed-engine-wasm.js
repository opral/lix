#!/usr/bin/env node
import { promises as fs } from "node:fs";
import { dirname, join } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const repoRoot = join(__dirname, "..", "..", "..");
const outDir = join(repoRoot, "packages", "engine-wasm", "dist");
const targetPath = join(outDir, "wasm", "lix_engine_wasm_bg.wasm");
const bytesPerLine = 20;

function chunk(values, size) {
  const result = [];
  for (let i = 0; i < values.length; i += size) {
    result.push(values.slice(i, i + size));
  }
  return result;
}

async function main() {
  const wasmBytes = await fs.readFile(targetPath);
  const numbers = Array.from(wasmBytes);
  const chunks = chunk(numbers, bytesPerLine);
  const literal = chunks
    .map((group, index) => {
      const suffix = index === chunks.length - 1 ? "" : ",";
      return `\t${group.map((value) => value.toString()).join(", ")}${suffix}`;
    })
    .join("\n");

  const header = `/**\n * @file Auto-generated WebAssembly payload for Lix engine.\n *\n * Generated by scripts/embed-engine-wasm.js â€” do not edit manually.\n */\n\n`;

  const jsBody = `${header}export const wasmBinary = new Uint8Array([\n${literal}\n]).buffer;\n\nexport default wasmBinary;\n`;
  const dtsBody = `export declare const wasmBinary: ArrayBuffer;\nexport default wasmBinary;\n`;

  await fs.mkdir(outDir, { recursive: true });
  await fs.writeFile(join(outDir, "engine-wasm-binary.js"), jsBody);
  await fs.writeFile(join(outDir, "engine-wasm-binary.d.ts"), dtsBody);
}

main().catch((error) => {
  console.error("[embed-engine-wasm] Failed to generate payload:\n", error);
  process.exit(1);
});
